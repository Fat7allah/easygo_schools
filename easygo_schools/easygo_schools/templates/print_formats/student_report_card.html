{% set student = frappe.get_doc("Student", doc.student) %}
{% set school_settings = frappe.get_single("School Settings") %}
{% set academic_year = frappe.get_doc("Academic Year", doc.academic_year) %}

<div class="print-format">
    <style>
        .print-format {
            font-family: "Helvetica Neue", Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .school-logo {
            max-height: 80px;
            margin-bottom: 10px;
        }
        
        .school-name {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .school-address {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .report-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-top: 15px;
        }
        
        .student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .info-label {
            font-weight: bold;
            width: 150px;
            color: #555;
        }
        
        .info-value {
            flex: 1;
        }
        
        .grades-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        
        .grades-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .grades-table th,
        .grades-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .grades-table th {
            background: #007bff;
            color: white;
            font-weight: bold;
        }
        
        .grades-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .grade-excellent {
            color: #28a745;
            font-weight: bold;
        }
        
        .grade-good {
            color: #17a2b8;
            font-weight: bold;
        }
        
        .grade-average {
            color: #ffc107;
            font-weight: bold;
        }
        
        .grade-poor {
            color: #dc3545;
            font-weight: bold;
        }
        
        .summary-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .attendance-section {
            margin-bottom: 30px;
        }
        
        .attendance-chart {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .attendance-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 0 15px;
            position: relative;
            overflow: hidden;
        }
        
        .attendance-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
        }
        
        .comments-section {
            margin-bottom: 30px;
        }
        
        .comment-box {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #fafafa;
            min-height: 80px;
        }
        
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        
        .signature-section {
            text-align: center;
            width: 200px;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 50px;
            padding-top: 5px;
        }
        
        .rtl {
            direction: rtl;
            text-align: right;
        }
        
        .rtl .info-row {
            flex-direction: row-reverse;
        }
        
        .rtl .summary-stats {
            flex-direction: row-reverse;
        }
        
        .rtl .footer {
            flex-direction: row-reverse;
        }
        
        @media print {
            .print-format {
                margin: 0;
                padding: 20px;
            }
        }
    </style>

    <div class="header">
        {% if school_settings.school_logo %}
        <img src="{{ school_settings.school_logo }}" alt="School Logo" class="school-logo">
        {% endif %}
        <div class="school-name">{{ school_settings.school_name or "EasyGo Education School" }}</div>
        <div class="school-address">
            {{ school_settings.address_line_1 or "" }}
            {% if school_settings.city %}, {{ school_settings.city }}{% endif %}
            {% if school_settings.phone %} | Tel: {{ school_settings.phone }}{% endif %}
        </div>
        <div class="report-title">{{ _("Student Report Card") }}</div>
    </div>

    <div class="student-info">
        <div class="info-row">
            <div class="info-label">{{ _("Student Name") }}:</div>
            <div class="info-value">{{ student.student_name }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Student ID") }}:</div>
            <div class="info-value">{{ student.name }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Class") }}:</div>
            <div class="info-value">{{ student.school_class }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Academic Year") }}:</div>
            <div class="info-value">{{ academic_year.academic_year_name }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Report Period") }}:</div>
            <div class="info-value">{{ doc.term or _("Full Year") }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Date of Birth") }}:</div>
            <div class="info-value">{{ frappe.utils.formatdate(student.date_of_birth) if student.date_of_birth else "" }}</div>
        </div>
    </div>

    <div class="grades-section">
        <div class="section-title">{{ _("Academic Performance") }}</div>
        
        {% set grades = frappe.get_list("Grade", 
            filters={"student": doc.student, "academic_year": doc.academic_year}, 
            fields=["subject", "score", "max_score", "percentage", "letter_grade", "grade_point"],
            order_by="subject") %}
        
        <table class="grades-table">
            <thead>
                <tr>
                    <th>{{ _("Subject") }}</th>
                    <th>{{ _("Score") }}</th>
                    <th>{{ _("Max Score") }}</th>
                    <th>{{ _("Percentage") }}</th>
                    <th>{{ _("Letter Grade") }}</th>
                    <th>{{ _("Grade Point") }}</th>
                    <th>{{ _("Remarks") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for grade in grades %}
                <tr>
                    <td>{{ grade.subject }}</td>
                    <td>{{ grade.score }}</td>
                    <td>{{ grade.max_score }}</td>
                    <td>{{ "%.1f"|format(grade.percentage) }}%</td>
                    <td class="{% if grade.letter_grade in ['A', 'A+'] %}grade-excellent{% elif grade.letter_grade in ['B', 'B+'] %}grade-good{% elif grade.letter_grade in ['C', 'C+'] %}grade-average{% else %}grade-poor{% endif %}">
                        {{ grade.letter_grade }}
                    </td>
                    <td>{{ "%.2f"|format(grade.grade_point) }}</td>
                    <td>
                        {% if grade.percentage >= 90 %}{{ _("Excellent") }}
                        {% elif grade.percentage >= 80 %}{{ _("Very Good") }}
                        {% elif grade.percentage >= 70 %}{{ _("Good") }}
                        {% elif grade.percentage >= 60 %}{{ _("Satisfactory") }}
                        {% else %}{{ _("Needs Improvement") }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if grades %}
    <div class="summary-section">
        <div class="section-title">{{ _("Academic Summary") }}</div>
        
        {% set total_score = grades|sum(attribute='score') %}
        {% set total_max_score = grades|sum(attribute='max_score') %}
        {% set overall_percentage = (total_score / total_max_score * 100) if total_max_score > 0 else 0 %}
        {% set avg_grade_point = (grades|sum(attribute='grade_point') / grades|length) if grades else 0 %}
        
        <div class="summary-stats">
            <div class="stat-item">
                <div class="stat-value">{{ grades|length }}</div>
                <div class="stat-label">{{ _("Subjects") }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ "%.1f"|format(overall_percentage) }}%</div>
                <div class="stat-label">{{ _("Overall Percentage") }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ "%.2f"|format(avg_grade_point) }}</div>
                <div class="stat-label">{{ _("GPA") }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">
                    {% if overall_percentage >= 90 %}A+
                    {% elif overall_percentage >= 85 %}A
                    {% elif overall_percentage >= 80 %}B+
                    {% elif overall_percentage >= 75 %}B
                    {% elif overall_percentage >= 70 %}C+
                    {% elif overall_percentage >= 65 %}C
                    {% elif overall_percentage >= 60 %}D
                    {% else %}F
                    {% endif %}
                </div>
                <div class="stat-label">{{ _("Overall Grade") }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="attendance-section">
        <div class="section-title">{{ _("Attendance Record") }}</div>
        
        {% set attendance_data = frappe.db.sql("""
            SELECT 
                COUNT(*) as total_days,
                SUM(CASE WHEN status = 'Present' THEN 1 ELSE 0 END) as present_days,
                SUM(CASE WHEN status = 'Absent' THEN 1 ELSE 0 END) as absent_days,
                SUM(CASE WHEN status = 'Late' THEN 1 ELSE 0 END) as late_days
            FROM `tabStudent Attendance`
            WHERE student = %s AND academic_year = %s
        """, (doc.student, doc.academic_year), as_dict=True) %}
        
        {% if attendance_data and attendance_data[0].total_days > 0 %}
        {% set attendance = attendance_data[0] %}
        {% set attendance_percentage = (attendance.present_days / attendance.total_days * 100) if attendance.total_days > 0 else 0 %}
        
        <div class="attendance-chart">
            <div style="width: 100px;">{{ _("Attendance") }}:</div>
            <div class="attendance-bar">
                <div class="attendance-fill" style="width: {{ attendance_percentage }}%;"></div>
            </div>
            <div style="width: 100px; text-align: right;">{{ "%.1f"|format(attendance_percentage) }}%</div>
        </div>
        
        <div class="info-row">
            <div class="info-label">{{ _("Total School Days") }}:</div>
            <div class="info-value">{{ attendance.total_days }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Days Present") }}:</div>
            <div class="info-value">{{ attendance.present_days }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Days Absent") }}:</div>
            <div class="info-value">{{ attendance.absent_days }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">{{ _("Days Late") }}:</div>
            <div class="info-value">{{ attendance.late_days }}</div>
        </div>
        {% else %}
        <p>{{ _("No attendance data available for this period.") }}</p>
        {% endif %}
    </div>

    <div class="comments-section">
        <div class="section-title">{{ _("Teacher Comments") }}</div>
        <div class="comment-box">
            {{ doc.teacher_comments or _("No comments provided.") }}
        </div>
    </div>

    <div class="comments-section">
        <div class="section-title">{{ _("Areas for Improvement") }}</div>
        <div class="comment-box">
            {{ doc.improvement_areas or _("Continue the excellent work!") }}
        </div>
    </div>

    <div class="footer">
        <div class="signature-section">
            <div class="signature-line">{{ _("Class Teacher") }}</div>
        </div>
        <div class="signature-section">
            <div class="signature-line">{{ _("Principal") }}</div>
        </div>
        <div class="signature-section">
            <div class="signature-line">{{ _("Parent/Guardian") }}</div>
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
        {{ _("Generated on") }} {{ frappe.utils.formatdate(frappe.utils.today()) }} | {{ _("EasyGo Education Management System") }}
    </div>
</div>
