{% extends "templates/web.html" %}

{% block title %}{{ _("Submit Homework") }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="/assets/easygo_education/css/app.css">
<style>
.submission-form {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.form-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.form-section h4 {
    color: #007bff;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.homework-info {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
}

.file-upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.file-upload-area.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-list {
    margin-top: 15px;
}

.file-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 5px;
}

.file-item .file-name {
    flex-grow: 1;
}

.file-item .file-size {
    color: #666;
    margin-right: 10px;
}

.file-item .remove-file {
    color: #dc3545;
    cursor: pointer;
}

.required-field {
    color: #dc3545;
}

.language-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.submission-status {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.status-draft {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.status-submitted {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.status-late {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
</style>
{% endblock %}

{% block page_content %}
<div class="language-toggle">
    <button class="btn btn-sm btn-outline-primary" onclick="toggleLanguage()">
        <span id="lang-text">عربي</span>
    </button>
</div>

<div class="container mt-4">
    <div class="submission-form">
        <div class="text-center mb-4">
            <h2>{{ _("Submit Homework") }}</h2>
            <p class="text-muted">{{ _("Upload your homework assignment") }}</p>
        </div>

        <!-- Homework Information -->
        <div class="homework-info" id="homework-info" style="display: none;">
            <h5>{{ _("Assignment Details") }}</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>{{ _("Subject") }}:</strong> <span id="homework-subject"></span></p>
                    <p><strong>{{ _("Title") }}:</strong> <span id="homework-title"></span></p>
                    <p><strong>{{ _("Due Date") }}:</strong> <span id="homework-due-date"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>{{ _("Teacher") }}:</strong> <span id="homework-teacher"></span></p>
                    <p><strong>{{ _("Max Score") }}:</strong> <span id="homework-max-score"></span></p>
                    <p><strong>{{ _("Status") }}:</strong> <span id="homework-status"></span></p>
                </div>
            </div>
            <div class="mt-2">
                <p><strong>{{ _("Description") }}:</strong></p>
                <div id="homework-description"></div>
            </div>
        </div>

        <!-- Submission Status -->
        <div id="submission-status" style="display: none;"></div>

        <form id="submission-form" method="post" enctype="multipart/form-data">
            <!-- Homework Selection -->
            <div class="form-section">
                <h4>{{ _("Select Assignment") }} <span class="required-field">*</span></h4>
                
                <div class="form-group">
                    <label for="homework">{{ _("Homework Assignment") }} <span class="required-field">*</span></label>
                    <select class="form-control" id="homework" name="homework" required>
                        <option value="">{{ _("Select homework assignment") }}</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Submission Content -->
            <div class="form-section" id="submission-section" style="display: none;">
                <h4>{{ _("Your Submission") }} <span class="required-field">*</span></h4>
                
                <div class="form-group">
                    <label for="submission-text">{{ _("Written Response") }}</label>
                    <textarea class="form-control" id="submission-text" name="submission_text" rows="6" 
                              placeholder="{{ _('Type your answer or explanation here...') }}"></textarea>
                    <small class="form-text text-muted">{{ _("You can provide a written response in addition to file uploads") }}</small>
                </div>
                
                <!-- File Upload -->
                <div class="form-group">
                    <label>{{ _("Upload Files") }}</label>
                    <div class="file-upload-area" id="file-upload-area">
                        <i class="fa fa-cloud-upload fa-3x text-muted mb-3"></i>
                        <h5>{{ _("Drag and drop files here") }}</h5>
                        <p class="text-muted">{{ _("or click to browse") }}</p>
                        <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.zip" style="display: none;">
                    </div>
                    <div class="file-list" id="file-list"></div>
                    <small class="form-text text-muted">
                        {{ _("Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, ZIP. Max size: 10MB per file") }}
                    </small>
                </div>
                
                <!-- Additional Notes -->
                <div class="form-group">
                    <label for="notes">{{ _("Additional Notes") }}</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              placeholder="{{ _('Any additional comments or notes about your submission...') }}"></textarea>
                </div>
                
                <!-- Late Submission -->
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="acknowledge-late" name="acknowledge_late">
                    <label class="form-check-label" for="acknowledge-late">
                        {{ _("I acknowledge this is a late submission") }}
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center" id="submit-section" style="display: none;">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    {{ _("Submit Homework") }}
                </button>
                <button type="button" class="btn btn-secondary btn-lg ml-2" id="save-draft-btn">
                    {{ _("Save as Draft") }}
                </button>
                <div class="mt-2">
                    <small class="text-muted">{{ _("Make sure to review your submission before submitting") }}</small>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
let selectedFiles = [];
let currentHomework = null;
let existingSubmission = null;

$(document).ready(function() {
    loadHomeworkAssignments();
    setupFileUpload();
    
    $('#homework').change(function() {
        const homeworkId = $(this).val();
        if (homeworkId) {
            loadHomeworkDetails(homeworkId);
            checkExistingSubmission(homeworkId);
        } else {
            hideSubmissionSection();
        }
    });
    
    $('#submission-form').on('submit', function(e) {
        e.preventDefault();
        submitHomework(false);
    });
    
    $('#save-draft-btn').click(function() {
        submitHomework(true);
    });
});

function loadHomeworkAssignments() {
    // Get current user's student record
    frappe.call({
        method: 'easygo_education.api.portal.get_student_homework',
        callback: function(r) {
            if (r.message) {
                let options = '<option value="">{{ _("Select homework assignment") }}</option>';
                
                r.message.forEach(homework => {
                    const dueDate = new Date(homework.due_date);
                    const now = new Date();
                    const isOverdue = dueDate < now;
                    const status = isOverdue ? '({{ _("Overdue") }})' : '';
                    
                    options += `<option value="${homework.name}">${homework.title} - ${homework.subject} ${status}</option>`;
                });
                
                $('#homework').html(options);
            }
        }
    });
}

function loadHomeworkDetails(homeworkId) {
    frappe.call({
        method: 'frappe.client.get',
        args: {
            doctype: 'Homework',
            name: homeworkId
        },
        callback: function(r) {
            if (r.message) {
                currentHomework = r.message;
                displayHomeworkInfo(r.message);
                showSubmissionSection();
            }
        }
    });
}

function displayHomeworkInfo(homework) {
    $('#homework-subject').text(homework.subject);
    $('#homework-title').text(homework.title);
    $('#homework-due-date').text(frappe.datetime.str_to_user(homework.due_date));
    $('#homework-teacher').text(homework.teacher_name || homework.teacher);
    $('#homework-max-score').text(homework.max_score || 'N/A');
    $('#homework-description').html(homework.description || '');
    
    // Check if overdue
    const dueDate = new Date(homework.due_date);
    const now = new Date();
    const isOverdue = dueDate < now;
    
    $('#homework-status').html(isOverdue ? 
        '<span class="badge badge-danger">{{ _("Overdue") }}</span>' : 
        '<span class="badge badge-success">{{ _("On Time") }}</span>'
    );
    
    $('#homework-info').show();
    
    // Show/hide late acknowledgment
    if (isOverdue) {
        $('#acknowledge-late').closest('.form-check').show();
    } else {
        $('#acknowledge-late').closest('.form-check').hide();
    }
}

function checkExistingSubmission(homeworkId) {
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'Homework Submission',
            filters: {
                homework: homeworkId,
                student: frappe.session.user
            },
            fields: ['name', 'submission_text', 'notes', 'status', 'submitted_date'],
            limit: 1
        },
        callback: function(r) {
            if (r.message && r.message.length > 0) {
                existingSubmission = r.message[0];
                loadExistingSubmission(existingSubmission);
            } else {
                existingSubmission = null;
                clearSubmissionForm();
            }
        }
    });
}

function loadExistingSubmission(submission) {
    $('#submission-text').val(submission.submission_text || '');
    $('#notes').val(submission.notes || '');
    
    // Show submission status
    let statusClass = 'status-draft';
    let statusText = '{{ _("Draft") }}';
    
    if (submission.status === 'Submitted') {
        statusClass = 'status-submitted';
        statusText = '{{ _("Submitted") }}';
    } else if (submission.status === 'Late') {
        statusClass = 'status-late';
        statusText = '{{ _("Late Submission") }}';
    }
    
    $('#submission-status').html(`
        <div class="submission-status ${statusClass}">
            <strong>{{ _("Current Status") }}:</strong> ${statusText}
            ${submission.submitted_date ? `<br><strong>{{ _("Submitted on") }}:</strong> ${frappe.datetime.str_to_user(submission.submitted_date)}` : ''}
        </div>
    `).show();
    
    // Update button text
    if (submission.status === 'Draft') {
        $('#submit-btn').text('{{ _("Submit Homework") }}');
    } else {
        $('#submit-btn').text('{{ _("Update Submission") }}');
    }
}

function clearSubmissionForm() {
    $('#submission-text').val('');
    $('#notes').val('');
    $('#submission-status').hide();
    $('#submit-btn').text('{{ _("Submit Homework") }}');
    selectedFiles = [];
    updateFileList();
}

function showSubmissionSection() {
    $('#submission-section').show();
    $('#submit-section').show();
}

function hideSubmissionSection() {
    $('#submission-section').hide();
    $('#submit-section').hide();
    $('#homework-info').hide();
    $('#submission-status').hide();
}

function setupFileUpload() {
    const uploadArea = $('#file-upload-area');
    const fileInput = $('#file-input');
    
    uploadArea.click(function() {
        fileInput.click();
    });
    
    fileInput.change(function() {
        handleFiles(this.files);
    });
    
    // Drag and drop
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        handleFiles(e.originalEvent.dataTransfer.files);
    });
}

function handleFiles(files) {
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            frappe.show_alert({
                message: `{{ _("File") }} ${file.name} {{ _("is too large. Maximum size is 10MB.") }}`,
                indicator: 'red'
            });
            continue;
        }
        
        selectedFiles.push(file);
    }
    
    updateFileList();
}

function updateFileList() {
    const fileList = $('#file-list');
    fileList.empty();
    
    selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        const fileItem = $(`
            <div class="file-item">
                <span class="file-name">${file.name}</span>
                <span class="file-size">${fileSize}</span>
                <span class="remove-file" onclick="removeFile(${index})">
                    <i class="fa fa-times"></i>
                </span>
            </div>
        `);
        fileList.append(fileItem);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

function submitHomework(isDraft) {
    const homeworkId = $('#homework').val();
    if (!homeworkId) {
        frappe.show_alert({
            message: '{{ _("Please select a homework assignment") }}',
            indicator: 'red'
        });
        return;
    }
    
    const submissionText = $('#submission-text').val();
    const notes = $('#notes').val();
    
    if (!isDraft && !submissionText && selectedFiles.length === 0) {
        frappe.show_alert({
            message: '{{ _("Please provide either a written response or upload files") }}',
            indicator: 'red'
        });
        return;
    }
    
    // Check if late submission acknowledgment is required
    const dueDate = new Date(currentHomework.due_date);
    const now = new Date();
    const isOverdue = dueDate < now;
    
    if (!isDraft && isOverdue && !$('#acknowledge-late').is(':checked')) {
        frappe.show_alert({
            message: '{{ _("Please acknowledge that this is a late submission") }}',
            indicator: 'red'
        });
        return;
    }
    
    const submissionData = {
        doctype: 'Homework Submission',
        homework: homeworkId,
        student: frappe.session.user,
        submission_text: submissionText,
        notes: notes,
        status: isDraft ? 'Draft' : (isOverdue ? 'Late' : 'Submitted'),
        submitted_date: isDraft ? null : frappe.datetime.now_datetime()
    };
    
    // Update existing submission or create new one
    if (existingSubmission) {
        submissionData.name = existingSubmission.name;
        
        frappe.call({
            method: 'frappe.client.save',
            args: {
                doc: submissionData
            },
            callback: function(r) {
                if (r.message) {
                    handleSubmissionSuccess(isDraft);
                }
            }
        });
    } else {
        frappe.call({
            method: 'frappe.client.insert',
            args: {
                doc: submissionData
            },
            callback: function(r) {
                if (r.message) {
                    existingSubmission = r.message;
                    handleSubmissionSuccess(isDraft);
                }
            }
        });
    }
}

function handleSubmissionSuccess(isDraft) {
    const message = isDraft ? 
        '{{ _("Homework saved as draft successfully") }}' : 
        '{{ _("Homework submitted successfully") }}';
    
    frappe.show_alert({
        message: message,
        indicator: 'green'
    });
    
    // Refresh submission status
    checkExistingSubmission($('#homework').val());
    
    if (!isDraft) {
        // Redirect to student portal after a delay
        setTimeout(function() {
            window.location.href = '/student-portal';
        }, 2000);
    }
}

function toggleLanguage() {
    const currentLang = $('html').attr('lang') || 'en';
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    
    $('html').attr('lang', newLang);
    $('body').toggleClass('rtl', newLang === 'ar');
    $('#lang-text').text(newLang === 'en' ? 'عربي' : 'English');
}
</script>
{% endblock %}
