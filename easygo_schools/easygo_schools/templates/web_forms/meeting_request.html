{% extends "templates/web.html" %}

{% block title %}{{ _("Meeting Request") }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="/assets/easygo_education/css/app.css">
<style>
.meeting-form {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.form-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.form-section h4 {
    color: #007bff;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.required-field {
    color: #dc3545;
}

.time-slot {
    display: inline-block;
    margin: 5px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.time-slot:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.time-slot.selected {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.language-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block page_content %}
<div class="language-toggle">
    <button class="btn btn-sm btn-outline-primary" onclick="toggleLanguage()">
        <span id="lang-text">عربي</span>
    </button>
</div>

<div class="container mt-4">
    <div class="meeting-form">
        <div class="text-center mb-4">
            <h2>{{ _("Request a Meeting") }}</h2>
            <p class="text-muted">{{ _("Schedule a meeting with your child's teacher") }}</p>
        </div>

        <form id="meeting-form" method="post">
            <!-- Student Selection -->
            <div class="form-section">
                <h4>{{ _("Student Information") }} <span class="required-field">*</span></h4>
                
                <div class="form-group">
                    <label for="student">{{ _("Select Student") }} <span class="required-field">*</span></label>
                    <select class="form-control" id="student" name="student" required>
                        <option value="">{{ _("Select your child") }}</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacher">{{ _("Select Teacher") }} <span class="required-field">*</span></label>
                    <select class="form-control" id="teacher" name="teacher" required>
                        <option value="">{{ _("Select teacher") }}</option>
                        <!-- Options will be populated based on student selection -->
                    </select>
                </div>
            </div>

            <!-- Meeting Details -->
            <div class="form-section">
                <h4>{{ _("Meeting Details") }} <span class="required-field">*</span></h4>
                
                <div class="form-group">
                    <label for="purpose">{{ _("Purpose of Meeting") }} <span class="required-field">*</span></label>
                    <select class="form-control" id="purpose" name="purpose" required>
                        <option value="">{{ _("Select purpose") }}</option>
                        <option value="Academic Progress">{{ _("Academic Progress") }}</option>
                        <option value="Behavioral Concerns">{{ _("Behavioral Concerns") }}</option>
                        <option value="General Discussion">{{ _("General Discussion") }}</option>
                        <option value="Homework Issues">{{ _("Homework Issues") }}</option>
                        <option value="Attendance Issues">{{ _("Attendance Issues") }}</option>
                        <option value="Special Needs">{{ _("Special Needs") }}</option>
                        <option value="Other">{{ _("Other") }}</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">{{ _("Description") }}</label>
                    <textarea class="form-control" id="description" name="description" rows="3" 
                              placeholder="{{ _('Please provide more details about what you would like to discuss') }}"></textarea>
                </div>
            </div>

            <!-- Preferred Schedule -->
            <div class="form-section">
                <h4>{{ _("Preferred Schedule") }} <span class="required-field">*</span></h4>
                
                <div class="form-group">
                    <label for="preferred_date">{{ _("Preferred Date") }} <span class="required-field">*</span></label>
                    <input type="date" class="form-control" id="preferred_date" name="preferred_date" required>
                </div>
                
                <div class="form-group">
                    <label>{{ _("Preferred Time") }} <span class="required-field">*</span></label>
                    <div id="time-slots">
                        <div class="time-slot" data-time="08:00">08:00</div>
                        <div class="time-slot" data-time="09:00">09:00</div>
                        <div class="time-slot" data-time="10:00">10:00</div>
                        <div class="time-slot" data-time="11:00">11:00</div>
                        <div class="time-slot" data-time="14:00">14:00</div>
                        <div class="time-slot" data-time="15:00">15:00</div>
                        <div class="time-slot" data-time="16:00">16:00</div>
                        <div class="time-slot" data-time="17:00">17:00</div>
                    </div>
                    <input type="hidden" id="preferred_time" name="preferred_time" required>
                </div>
                
                <div class="form-group">
                    <label for="alternative_date">{{ _("Alternative Date") }}</label>
                    <input type="date" class="form-control" id="alternative_date" name="alternative_date">
                </div>
                
                <div class="form-group">
                    <label for="alternative_time">{{ _("Alternative Time") }}</label>
                    <select class="form-control" id="alternative_time" name="alternative_time">
                        <option value="">{{ _("Select alternative time") }}</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                    </select>
                </div>
            </div>

            <!-- Meeting Format -->
            <div class="form-section">
                <h4>{{ _("Meeting Format") }}</h4>
                
                <div class="form-group">
                    <label for="meeting_type">{{ _("Meeting Type") }}</label>
                    <select class="form-control" id="meeting_type" name="meeting_type">
                        <option value="In Person">{{ _("In Person") }}</option>
                        <option value="Video Call">{{ _("Video Call") }}</option>
                        <option value="Phone Call">{{ _("Phone Call") }}</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="duration">{{ _("Expected Duration") }}</label>
                    <select class="form-control" id="duration" name="duration">
                        <option value="15 minutes">15 {{ _("minutes") }}</option>
                        <option value="30 minutes" selected>30 {{ _("minutes") }}</option>
                        <option value="45 minutes">45 {{ _("minutes") }}</option>
                        <option value="60 minutes">60 {{ _("minutes") }}</option>
                    </select>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="form-section">
                <h4>{{ _("Contact Information") }}</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="parent_name">{{ _("Your Name") }}</label>
                            <input type="text" class="form-control" id="parent_name" name="parent_name">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="phone_number">{{ _("Phone Number") }}</label>
                            <input type="tel" class="form-control" id="phone_number" name="phone_number">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">{{ _("Email Address") }}</label>
                    <input type="email" class="form-control" id="email" name="email" readonly>
                </div>
            </div>

            <!-- Additional Notes -->
            <div class="form-section">
                <h4>{{ _("Additional Information") }}</h4>
                
                <div class="form-group">
                    <label for="notes">{{ _("Additional Notes") }}</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              placeholder="{{ _('Any additional information you would like the teacher to know before the meeting') }}"></textarea>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="urgent" name="urgent">
                    <label class="form-check-label" for="urgent">
                        {{ _("This is an urgent matter") }}
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    {{ _("Submit Meeting Request") }}
                </button>
                <div class="mt-2">
                    <small class="text-muted">{{ _("You will receive a confirmation email once the teacher responds") }}</small>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    loadStudents();
    setupTimeSlots();
    setupDateValidation();
    
    $('#student').change(function() {
        loadTeachers($(this).val());
    });
    
    $('#meeting-form').on('submit', function(e) {
        e.preventDefault();
        submitMeetingRequest();
    });
    
    // Set user email
    $('#email').val(frappe.session.user);
});

function loadStudents() {
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'Student',
            filters: {
                guardian_email: frappe.session.user,
                status: 'Active'
            },
            fields: ['name', 'student_name', 'school_class'],
            order_by: 'student_name'
        },
        callback: function(r) {
            if (r.message) {
                const options = r.message.map(student => 
                    `<option value="${student.name}">${student.student_name} (${student.school_class})</option>`
                ).join('');
                $('#student').append(options);
            }
        }
    });
}

function loadTeachers(studentId) {
    if (!studentId) {
        $('#teacher').html('<option value="">{{ _("Select teacher") }}</option>');
        return;
    }
    
    // Get student's class
    frappe.call({
        method: 'frappe.client.get_value',
        args: {
            doctype: 'Student',
            fieldname: 'school_class',
            filters: {name: studentId}
        },
        callback: function(r) {
            if (r.message && r.message.school_class) {
                // Get teachers for this class
                frappe.call({
                    method: 'frappe.client.get_list',
                    args: {
                        doctype: 'Course Schedule',
                        filters: {
                            school_class: r.message.school_class,
                            is_active: 1
                        },
                        fields: ['instructor'],
                        distinct: true
                    },
                    callback: function(r) {
                        if (r.message) {
                            let options = '<option value="">{{ _("Select teacher") }}</option>';
                            
                            // Get teacher details
                            const teacherPromises = r.message.map(item => 
                                frappe.call({
                                    method: 'frappe.client.get_value',
                                    args: {
                                        doctype: 'Employee',
                                        fieldname: 'employee_name',
                                        filters: {name: item.instructor}
                                    }
                                })
                            );
                            
                            Promise.all(teacherPromises).then(results => {
                                results.forEach((result, index) => {
                                    if (result.message) {
                                        const teacherId = r.message[index].instructor;
                                        const teacherName = result.message.employee_name;
                                        options += `<option value="${teacherId}">${teacherName}</option>`;
                                    }
                                });
                                $('#teacher').html(options);
                            });
                        }
                    }
                });
            }
        }
    });
}

function setupTimeSlots() {
    $('.time-slot').click(function() {
        $('.time-slot').removeClass('selected');
        $(this).addClass('selected');
        $('#preferred_time').val($(this).data('time'));
    });
}

function setupDateValidation() {
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    
    $('#preferred_date, #alternative_date').attr('min', minDate);
}

function submitMeetingRequest() {
    if (!$('#preferred_time').val()) {
        frappe.show_alert({
            message: '{{ _("Please select a preferred time") }}',
            indicator: 'red'
        });
        return;
    }
    
    const formData = new FormData($('#meeting-form')[0]);
    
    // Convert FormData to object
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Create meeting request
    const meetingData = {
        doctype: 'Meeting Request',
        student: data.student,
        teacher: data.teacher,
        purpose: data.purpose,
        description: data.description,
        preferred_date: data.preferred_date,
        preferred_time: data.preferred_time,
        alternative_date: data.alternative_date,
        alternative_time: data.alternative_time,
        meeting_type: data.meeting_type,
        duration: data.duration,
        parent_name: data.parent_name,
        phone_number: data.phone_number,
        email: data.email,
        notes: data.notes,
        is_urgent: data.urgent ? 1 : 0,
        requested_by: frappe.session.user,
        status: 'Pending'
    };
    
    frappe.call({
        method: 'frappe.client.insert',
        args: {
            doc: meetingData
        },
        callback: function(r) {
            if (r.message) {
                frappe.show_alert({
                    message: '{{ _("Meeting request submitted successfully. The teacher will respond within 24 hours.") }}',
                    indicator: 'green'
                });
                
                // Reset form
                $('#meeting-form')[0].reset();
                $('.time-slot').removeClass('selected');
                $('#preferred_time').val('');
                
                // Redirect to parent portal
                setTimeout(function() {
                    window.location.href = '/parent-portal';
                }, 2000);
            }
        },
        error: function(r) {
            frappe.show_alert({
                message: '{{ _("Error submitting meeting request. Please try again.") }}',
                indicator: 'red'
            });
        }
    });
}

function toggleLanguage() {
    const currentLang = $('html').attr('lang') || 'en';
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    
    $('html').attr('lang', newLang);
    $('body').toggleClass('rtl', newLang === 'ar');
    $('#lang-text').text(newLang === 'en' ? 'عربي' : 'English');
}
</script>
{% endblock %}
