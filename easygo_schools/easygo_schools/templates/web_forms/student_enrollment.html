{% extends "templates/web.html" %}

{% block title %}{{ _("Student Enrollment") }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="/assets/easygo_education/css/app.css">
<style>
.enrollment-form {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.form-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.form-section h4 {
    color: #007bff;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.required-field {
    color: #dc3545;
}

.form-help {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}

.language-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block page_content %}
<div class="language-toggle">
    <button class="btn btn-sm btn-outline-primary" onclick="toggleLanguage()">
        <span id="lang-text">عربي</span>
    </button>
</div>

<div class="container mt-4">
    <div class="enrollment-form">
        <div class="text-center mb-4">
            <h2>{{ _("Student Enrollment Form") }}</h2>
            <p class="text-muted">{{ _("Please fill out all required information to enroll your child") }}</p>
        </div>

        <form id="enrollment-form" method="post">
            <!-- Student Information -->
            <div class="form-section">
                <h4>{{ _("Student Information") }} <span class="required-field">*</span></h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="first_name">{{ _("First Name") }} <span class="required-field">*</span></label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="last_name">{{ _("Last Name") }} <span class="required-field">*</span></label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="date_of_birth">{{ _("Date of Birth") }} <span class="required-field">*</span></label>
                            <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="gender">{{ _("Gender") }} <span class="required-field">*</span></label>
                            <select class="form-control" id="gender" name="gender" required>
                                <option value="">{{ _("Select Gender") }}</option>
                                <option value="Male">{{ _("Male") }}</option>
                                <option value="Female">{{ _("Female") }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="nationality">{{ _("Nationality") }}</label>
                            <input type="text" class="form-control" id="nationality" name="nationality" value="Moroccan">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="place_of_birth">{{ _("Place of Birth") }}</label>
                            <input type="text" class="form-control" id="place_of_birth" name="place_of_birth">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="massar_code">{{ _("MASSAR Code") }}</label>
                    <input type="text" class="form-control" id="massar_code" name="massar_code" pattern="[A-Z]{1}[0-9]{9}">
                    <div class="form-help">{{ _("Format: 1 letter followed by 9 digits (e.g., M123456789)") }}</div>
                </div>
            </div>

            <!-- Academic Information -->
            <div class="form-section">
                <h4>{{ _("Academic Information") }} <span class="required-field">*</span></h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="academic_year">{{ _("Academic Year") }} <span class="required-field">*</span></label>
                            <select class="form-control" id="academic_year" name="academic_year" required>
                                <option value="">{{ _("Select Academic Year") }}</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="school_class">{{ _("Desired Class") }} <span class="required-field">*</span></label>
                            <select class="form-control" id="school_class" name="school_class" required>
                                <option value="">{{ _("Select Class") }}</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="previous_school">{{ _("Previous School") }}</label>
                    <input type="text" class="form-control" id="previous_school" name="previous_school">
                </div>
            </div>

            <!-- Guardian Information -->
            <div class="form-section">
                <h4>{{ _("Guardian Information") }} <span class="required-field">*</span></h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="guardian_name">{{ _("Guardian Name") }} <span class="required-field">*</span></label>
                            <input type="text" class="form-control" id="guardian_name" name="guardian_name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="guardian_relationship">{{ _("Relationship") }} <span class="required-field">*</span></label>
                            <select class="form-control" id="guardian_relationship" name="guardian_relationship" required>
                                <option value="">{{ _("Select Relationship") }}</option>
                                <option value="Father">{{ _("Father") }}</option>
                                <option value="Mother">{{ _("Mother") }}</option>
                                <option value="Guardian">{{ _("Guardian") }}</option>
                                <option value="Other">{{ _("Other") }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="guardian_email">{{ _("Email Address") }} <span class="required-field">*</span></label>
                            <input type="email" class="form-control" id="guardian_email" name="guardian_email" required>
                            <div class="form-help">{{ _("This will be used for portal access and notifications") }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="guardian_phone">{{ _("Phone Number") }} <span class="required-field">*</span></label>
                            <input type="tel" class="form-control" id="guardian_phone" name="guardian_phone" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">{{ _("Address") }} <span class="required-field">*</span></label>
                    <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="form-section">
                <h4>{{ _("Emergency Contact") }}</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emergency_contact_name">{{ _("Emergency Contact Name") }}</label>
                            <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="emergency_contact_phone">{{ _("Emergency Contact Phone") }}</label>
                            <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Information -->
            <div class="form-section">
                <h4>{{ _("Medical Information") }}</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="blood_group">{{ _("Blood Group") }}</label>
                            <select class="form-control" id="blood_group" name="blood_group">
                                <option value="">{{ _("Select Blood Group") }}</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="allergies">{{ _("Known Allergies") }}</label>
                            <input type="text" class="form-control" id="allergies" name="allergies">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="medical_conditions">{{ _("Medical Conditions") }}</label>
                    <textarea class="form-control" id="medical_conditions" name="medical_conditions" rows="2"></textarea>
                    <div class="form-help">{{ _("Please list any medical conditions or medications") }}</div>
                </div>
            </div>

            <!-- Documents -->
            <div class="form-section">
                <h4>{{ _("Required Documents") }}</h4>
                
                <div class="form-group">
                    <label for="birth_certificate">{{ _("Birth Certificate") }}</label>
                    <input type="file" class="form-control-file" id="birth_certificate" name="birth_certificate" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                
                <div class="form-group">
                    <label for="previous_school_certificate">{{ _("Previous School Certificate") }}</label>
                    <input type="file" class="form-control-file" id="previous_school_certificate" name="previous_school_certificate" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                
                <div class="form-group">
                    <label for="medical_certificate">{{ _("Medical Certificate") }}</label>
                    <input type="file" class="form-control-file" id="medical_certificate" name="medical_certificate" accept=".pdf,.jpg,.jpeg,.png">
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="form-section">
                <h4>{{ _("Terms and Conditions") }}</h4>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="terms_accepted" name="terms_accepted" required>
                    <label class="form-check-label" for="terms_accepted">
                        {{ _("I accept the school's terms and conditions") }} <span class="required-field">*</span>
                    </label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="data_consent" name="data_consent" required>
                    <label class="form-check-label" for="data_consent">
                        {{ _("I consent to the processing of personal data for educational purposes") }} <span class="required-field">*</span>
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    {{ _("Submit Enrollment Application") }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    loadAcademicYears();
    loadClasses();
    
    $('#enrollment-form').on('submit', function(e) {
        e.preventDefault();
        submitEnrollment();
    });
});

function loadAcademicYears() {
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'Academic Year',
            filters: {
                is_active: 1
            },
            fields: ['name', 'year_name'],
            order_by: 'year_start_date desc'
        },
        callback: function(r) {
            if (r.message) {
                const options = r.message.map(year => 
                    `<option value="${year.name}">${year.year_name}</option>`
                ).join('');
                $('#academic_year').append(options);
            }
        }
    });
}

function loadClasses() {
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'School Class',
            filters: {
                is_active: 1
            },
            fields: ['name', 'class_name', 'level'],
            order_by: 'level, class_name'
        },
        callback: function(r) {
            if (r.message) {
                const options = r.message.map(cls => 
                    `<option value="${cls.name}">${cls.class_name} (${cls.level})</option>`
                ).join('');
                $('#school_class').append(options);
            }
        }
    });
}

function submitEnrollment() {
    const formData = new FormData($('#enrollment-form')[0]);
    
    // Convert FormData to object
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Create student record
    const studentData = {
        doctype: 'Student',
        first_name: data.first_name,
        last_name: data.last_name,
        student_name: `${data.first_name} ${data.last_name}`,
        date_of_birth: data.date_of_birth,
        gender: data.gender,
        nationality: data.nationality,
        place_of_birth: data.place_of_birth,
        massar_code: data.massar_code,
        academic_year: data.academic_year,
        school_class: data.school_class,
        previous_school: data.previous_school,
        guardian_name: data.guardian_name,
        guardian_relationship: data.guardian_relationship,
        guardian_email: data.guardian_email,
        guardian_phone: data.guardian_phone,
        address: data.address,
        emergency_contact_name: data.emergency_contact_name,
        emergency_contact_phone: data.emergency_contact_phone,
        blood_group: data.blood_group,
        allergies: data.allergies,
        medical_conditions: data.medical_conditions,
        status: 'Pending Approval'
    };
    
    frappe.call({
        method: 'frappe.client.insert',
        args: {
            doc: studentData
        },
        callback: function(r) {
            if (r.message) {
                frappe.show_alert({
                    message: '{{ _("Enrollment application submitted successfully. You will receive a confirmation email shortly.") }}',
                    indicator: 'green'
                });
                
                // Reset form
                $('#enrollment-form')[0].reset();
                
                // Redirect to success page
                setTimeout(function() {
                    window.location.href = '/enrollment-success';
                }, 2000);
            }
        },
        error: function(r) {
            frappe.show_alert({
                message: '{{ _("Error submitting enrollment. Please check your information and try again.") }}',
                indicator: 'red'
            });
        }
    });
}

function toggleLanguage() {
    const currentLang = $('html').attr('lang') || 'en';
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    
    $('html').attr('lang', newLang);
    $('body').toggleClass('rtl', newLang === 'ar');
    $('#lang-text').text(newLang === 'en' ? 'عربي' : 'English');
}
</script>
{% endblock %}
