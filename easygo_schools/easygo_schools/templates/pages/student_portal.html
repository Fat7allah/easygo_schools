{% extends "templates/web.html" %}

{% block title %}{{ _("Student Portal") }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="/assets/easygo_education/css/app.css">
<style>
.dashboard-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.schedule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-left: 4px solid #007bff;
    margin-bottom: 10px;
    background: #f8f9fa;
}

.grade-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}

.homework-item {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
}

.homework-item.overdue {
    border-left: 4px solid #dc3545;
    background: #fff5f5;
}

.attendance-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
}

.stat-item {
    padding: 10px;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007bff;
}

.language-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}
</style>
{% endblock %}

{% block page_content %}
<div class="language-toggle">
    <button class="btn btn-sm btn-outline-primary" onclick="toggleLanguage()">
        <span id="lang-text">عربي</span>
    </button>
</div>

<div class="container-fluid mt-4" id="student-portal">
    <!-- Loading State -->
    <div id="loading" class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">{{ _("Loading...") }}</span>
        </div>
    </div>

    <!-- Portal Content -->
    <div id="portal-content" style="display: none;">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex align-items-center">
                        <img id="student-photo" src="/assets/frappe/images/ui/avatar.png" 
                             class="rounded-circle mr-3" width="60" height="60" alt="Student Photo">
                        <div>
                            <h3 id="student-name" class="mb-1">{{ _("Welcome") }}</h3>
                            <p id="student-class" class="text-muted mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Today's Schedule -->
            <div class="col-lg-6 col-md-12">
                <div class="dashboard-card">
                    <h5>{{ _("Today's Schedule") }}</h5>
                    <div id="today-schedule">
                        <!-- Schedule items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Attendance Summary -->
            <div class="col-lg-6 col-md-12">
                <div class="dashboard-card">
                    <h5>{{ _("Attendance Summary (Last 30 Days)") }}</h5>
                    <div class="attendance-stats">
                        <div class="stat-item">
                            <div id="attendance-percentage" class="stat-number">0%</div>
                            <small>{{ _("Attendance Rate") }}</small>
                        </div>
                        <div class="stat-item">
                            <div id="present-days" class="stat-number">0</div>
                            <small>{{ _("Present Days") }}</small>
                        </div>
                        <div class="stat-item">
                            <div id="absent-days" class="stat-number">0</div>
                            <small>{{ _("Absent Days") }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Recent Grades -->
            <div class="col-lg-6 col-md-12">
                <div class="dashboard-card">
                    <h5>{{ _("Recent Grades") }}</h5>
                    <div id="recent-grades">
                        <!-- Grades will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Pending Homework -->
            <div class="col-lg-6 col-md-12">
                <div class="dashboard-card">
                    <h5>{{ _("Pending Homework") }}</h5>
                    <div id="pending-homework">
                        <!-- Homework will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5>{{ _("Quick Actions") }}</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="viewTimetable()">
                            {{ _("View Timetable") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="viewAttendance()">
                            {{ _("View Attendance") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="viewHomework()">
                            {{ _("View Homework") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="viewGrades()">
                            {{ _("View Grades") }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Timetable Modal -->
<div class="modal fade" id="timetableModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Weekly Timetable") }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="timetable-content">
                    <!-- Timetable will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Homework Modal -->
<div class="modal fade" id="homeworkModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Homework Assignments") }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="homework-content">
                    <!-- Homework will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Homework Submission Modal -->
<div class="modal fade" id="homeworkSubmissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Submit Homework") }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="homework-submission-form">
                    <input type="hidden" id="homework-id" name="homework">
                    <input type="hidden" id="student-id" name="student">
                    
                    <div class="form-group">
                        <label for="submission-notes">{{ _("Notes") }}</label>
                        <textarea class="form-control" id="submission-notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="submission-files">{{ _("Attach Files") }}</label>
                        <input type="file" class="form-control-file" id="submission-files" name="files" multiple>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
                <button type="button" class="btn btn-primary" onclick="submitHomework()">{{ _("Submit") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
let dashboardData = null;

$(document).ready(function() {
    loadDashboard();
});

function loadDashboard() {
    frappe.call({
        method: 'easygo_education.api.portal.get_portal_home',
        args: {
            role: 'Student'
        },
        callback: function(r) {
            if (r.message) {
                dashboardData = r.message;
                populateDashboard();
                $('#loading').hide();
                $('#portal-content').show();
            }
        }
    });
}

function populateDashboard() {
    const data = dashboardData;
    
    // Student info
    $('#student-name').text(data.student_info.name);
    $('#student-class').text(data.student_info.class);
    if (data.student_info.photo) {
        $('#student-photo').attr('src', data.student_info.photo);
    }
    
    // Today's schedule
    const scheduleHtml = data.today_schedule.map(item => `
        <div class="schedule-item">
            <div>
                <strong>${item.subject}</strong><br>
                <small>${item.instructor} • ${item.room}</small>
            </div>
            <div class="text-right">
                <small>${item.start_time} - ${item.end_time}</small>
            </div>
        </div>
    `).join('');
    $('#today-schedule').html(scheduleHtml || '<p class="text-muted">{{ _("No classes today") }}</p>');
    
    // Attendance summary
    $('#attendance-percentage').text(data.attendance_summary.percentage + '%');
    $('#present-days').text(data.attendance_summary.present_days);
    $('#absent-days').text(data.attendance_summary.absent_days);
    
    // Recent grades
    const gradesHtml = data.recent_grades.map(grade => `
        <div class="grade-item">
            <div>
                <strong>${grade.subject}</strong><br>
                <small>${grade.assessment_name}</small>
            </div>
            <div class="text-right">
                <strong>${grade.grade}/${grade.max_grade}</strong><br>
                <small>${frappe.datetime.str_to_user(grade.assessment_date)}</small>
            </div>
        </div>
    `).join('');
    $('#recent-grades').html(gradesHtml || '<p class="text-muted">{{ _("No grades available") }}</p>');
    
    // Pending homework
    const homeworkHtml = data.pending_homework.map(hw => {
        const isOverdue = new Date(hw.due_date) < new Date();
        return `
            <div class="homework-item ${isOverdue ? 'overdue' : ''}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${hw.title}</strong><br>
                        <small>${hw.subject}</small><br>
                        <small class="text-muted">${hw.description}</small>
                    </div>
                    <div class="text-right">
                        <small>Due: ${frappe.datetime.str_to_user(hw.due_date)}</small><br>
                        <button class="btn btn-sm btn-primary" onclick="openHomeworkSubmission('${hw.name}', '${hw.title}')">
                            {{ _("Submit") }}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    $('#pending-homework').html(homeworkHtml || '<p class="text-muted">{{ _("No pending homework") }}</p>');
}

function viewTimetable() {
    frappe.call({
        method: 'easygo_education.api.portal.get_timetable',
        callback: function(r) {
            if (r.message) {
                displayTimetable(r.message);
                $('#timetableModal').modal('show');
            }
        }
    });
}

function displayTimetable(timetable) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>{{ _("Time") }}</th>';
    
    days.forEach(day => {
        if (timetable[day]) {
            html += `<th>${__(day)}</th>`;
        }
    });
    html += '</tr></thead><tbody>';
    
    // Get all unique time slots
    const timeSlots = new Set();
    Object.values(timetable).forEach(daySchedule => {
        daySchedule.forEach(item => {
            timeSlots.add(item.start_time);
        });
    });
    
    Array.from(timeSlots).sort().forEach(time => {
        html += `<tr><td><strong>${time}</strong></td>`;
        days.forEach(day => {
            if (timetable[day]) {
                const classItem = timetable[day].find(item => item.start_time === time);
                if (classItem) {
                    html += `<td>${classItem.subject}<br><small>${classItem.room}</small></td>`;
                } else {
                    html += '<td></td>';
                }
            }
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    $('#timetable-content').html(html);
}

function viewAttendance() {
    window.location.href = '/student-attendance';
}

function viewHomework() {
    frappe.call({
        method: 'easygo_education.api.portal.list_homework',
        callback: function(r) {
            if (r.message) {
                displayHomework(r.message);
                $('#homeworkModal').modal('show');
            }
        }
    });
}

function displayHomework(homework) {
    const html = homework.map(hw => `
        <div class="homework-item">
            <div class="d-flex justify-content-between">
                <div>
                    <h6>${hw.title}</h6>
                    <p><strong>{{ _("Subject") }}:</strong> ${hw.subject}</p>
                    <p><strong>{{ _("Due Date") }}:</strong> ${frappe.datetime.str_to_user(hw.due_date)}</p>
                    <p>${hw.description}</p>
                    ${hw.attachment ? `<p><a href="${hw.attachment}" target="_blank">{{ _("View Attachment") }}</a></p>` : ''}
                </div>
                <div>
                    ${hw.submission_id ? 
                        `<span class="badge badge-success">{{ _("Submitted") }}</span>
                         ${hw.grade ? `<br><small>{{ _("Grade") }}: ${hw.grade}</small>` : ''}` :
                        `<button class="btn btn-sm btn-primary" onclick="openHomeworkSubmission('${hw.name}', '${hw.title}')">
                            {{ _("Submit") }}
                         </button>`
                    }
                </div>
            </div>
        </div>
    `).join('');
    
    $('#homework-content').html(html);
}

function viewGrades() {
    window.location.href = '/student-grades';
}

function openHomeworkSubmission(homeworkId, title) {
    $('#homework-id').val(homeworkId);
    $('#student-id').val(dashboardData.student_info.name);
    $('#homeworkSubmissionModal .modal-title').text(`{{ _("Submit") }}: ${title}`);
    $('#homeworkSubmissionModal').modal('show');
}

function submitHomework() {
    const formData = new FormData();
    formData.append('student', $('#student-id').val());
    formData.append('homework', $('#homework-id').val());
    formData.append('notes', $('#submission-notes').val());
    
    const files = $('#submission-files')[0].files;
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    frappe.call({
        method: 'easygo_education.api.portal.submit_homework',
        args: {
            student: $('#student-id').val(),
            homework: $('#homework-id').val(),
            notes: $('#submission-notes').val()
        },
        callback: function(r) {
            if (r.message) {
                frappe.show_alert({
                    message: r.message.message,
                    indicator: 'green'
                });
                $('#homeworkSubmissionModal').modal('hide');
                loadDashboard(); // Refresh dashboard
            }
        }
    });
}

function toggleLanguage() {
    const currentLang = $('html').attr('lang') || 'en';
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    
    $('html').attr('lang', newLang);
    $('body').toggleClass('rtl', newLang === 'ar');
    $('#lang-text').text(newLang === 'en' ? 'عربي' : 'English');
    
    // Save preference
    frappe.call({
        method: 'frappe.core.doctype.user.user.set_user_preference',
        args: {
            key: 'language',
            value: newLang
        }
    });
}
</script>
{% endblock %}
