{% extends "templates/web.html" %}

{% block title %}{{ _("Parent Portal") }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" href="/assets/easygo_education/css/app.css">
<style>
.child-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.alert-item {
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.child-photo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.action-btn {
    padding: 8px 16px;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    transition: all 0.2s;
}

.action-btn:hover {
    background: #007bff;
    color: white;
    text-decoration: none;
}

.grade-display {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
}

.grade-score {
    font-size: 1.5em;
    font-weight: bold;
    color: #007bff;
}
</style>
{% endblock %}

{% block page_content %}
<div class="language-toggle">
    <button class="btn btn-sm btn-outline-primary" onclick="toggleLanguage()">
        <span id="lang-text">عربي</span>
    </button>
</div>

<div class="container-fluid mt-4" id="parent-portal">
    <!-- Loading State -->
    <div id="loading" class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">{{ _("Loading...") }}</span>
        </div>
    </div>

    <!-- Portal Content -->
    <div id="portal-content" style="display: none;">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>{{ _("Parent Portal") }}</h2>
                <p class="text-muted">{{ _("Monitor your children's academic progress and school activities") }}</p>
            </div>
        </div>

        <!-- Children Cards -->
        <div id="children-container">
            <!-- Children cards will be populated here -->
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5>{{ _("Quick Actions") }}</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="viewAllAttendance()">
                            {{ _("View All Attendance") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="viewAllGrades()">
                            {{ _("View All Grades") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="viewFees()">
                            {{ _("View Fees") }}
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="contactTeacher()">
                            {{ _("Contact Teacher") }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Justification Modal -->
<div class="modal fade" id="justificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Submit Attendance Justification") }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="justification-form">
                    <input type="hidden" id="justification-student" name="student">
                    <input type="hidden" id="justification-date" name="attendance_date">
                    
                    <div class="form-group">
                        <label for="justification-reason">{{ _("Reason for Absence") }}</label>
                        <select class="form-control" id="justification-reason" name="reason" required>
                            <option value="">{{ _("Select reason") }}</option>
                            <option value="Illness">{{ _("Illness") }}</option>
                            <option value="Medical Appointment">{{ _("Medical Appointment") }}</option>
                            <option value="Family Emergency">{{ _("Family Emergency") }}</option>
                            <option value="Religious Observance">{{ _("Religious Observance") }}</option>
                            <option value="Other">{{ _("Other") }}</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="justification-details">{{ _("Additional Details") }}</label>
                        <textarea class="form-control" id="justification-details" name="details" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="justification-attachment">{{ _("Supporting Document") }}</label>
                        <input type="file" class="form-control-file" id="justification-attachment" name="attachment">
                        <small class="form-text text-muted">{{ _("Optional: Medical certificate, etc.") }}</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
                <button type="button" class="btn btn-primary" onclick="submitJustification()">{{ _("Submit") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Meeting Request Modal -->
<div class="modal fade" id="meetingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _("Request Meeting") }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="meeting-form">
                    <div class="form-group">
                        <label for="meeting-student">{{ _("Student") }}</label>
                        <select class="form-control" id="meeting-student" name="student" required>
                            <!-- Options will be populated -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="meeting-teacher">{{ _("Teacher") }}</label>
                        <select class="form-control" id="meeting-teacher" name="teacher" required>
                            <option value="">{{ _("Select teacher") }}</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="meeting-purpose">{{ _("Purpose") }}</label>
                        <select class="form-control" id="meeting-purpose" name="purpose" required>
                            <option value="">{{ _("Select purpose") }}</option>
                            <option value="Academic Progress">{{ _("Academic Progress") }}</option>
                            <option value="Behavioral Concerns">{{ _("Behavioral Concerns") }}</option>
                            <option value="General Discussion">{{ _("General Discussion") }}</option>
                            <option value="Other">{{ _("Other") }}</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="meeting-preferred-date">{{ _("Preferred Date") }}</label>
                        <input type="date" class="form-control" id="meeting-preferred-date" name="preferred_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="meeting-preferred-time">{{ _("Preferred Time") }}</label>
                        <select class="form-control" id="meeting-preferred-time" name="preferred_time" required>
                            <option value="">{{ _("Select time") }}</option>
                            <option value="08:00">08:00</option>
                            <option value="09:00">09:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="meeting-notes">{{ _("Additional Notes") }}</label>
                        <textarea class="form-control" id="meeting-notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button>
                <button type="button" class="btn btn-primary" onclick="submitMeetingRequest()">{{ _("Submit Request") }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
let dashboardData = null;

$(document).ready(function() {
    loadDashboard();
});

function loadDashboard() {
    frappe.call({
        method: 'easygo_education.api.portal.get_portal_home',
        args: {
            role: 'Parent'
        },
        callback: function(r) {
            if (r.message) {
                dashboardData = r.message;
                populateDashboard();
                $('#loading').hide();
                $('#portal-content').show();
            }
        }
    });
}

function populateDashboard() {
    const data = dashboardData;
    
    // Populate children cards
    const childrenHtml = data.children.map(child => {
        const student = child.student_info;
        const alerts = child.alerts;
        const latestGrade = child.latest_grade;
        
        const alertsHtml = alerts.map(alert => `
            <div class="alert-item alert-${alert.severity}">
                <i class="fa fa-${alert.type === 'attendance' ? 'calendar-times' : 'money-bill'}"></i>
                ${alert.message}
            </div>
        `).join('');
        
        const gradeHtml = latestGrade ? `
            <div class="grade-display">
                <div class="grade-score">${latestGrade.grade}/${latestGrade.max_grade}</div>
                <small>${latestGrade.subject}</small>
            </div>
        ` : '<div class="grade-display"><small>{{ _("No recent grades") }}</small></div>';
        
        return `
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="child-card">
                    <div class="d-flex align-items-start">
                        <img src="${student.photo || '/assets/frappe/images/ui/avatar.png'}" 
                             class="child-photo mr-3" alt="${student.student_name}">
                        <div class="flex-grow-1">
                            <h5>${student.student_name}</h5>
                            <p class="text-muted mb-2">${student.school_class}</p>
                            
                            ${alertsHtml ? `<div class="mb-3">${alertsHtml}</div>` : ''}
                            
                            <div class="row">
                                <div class="col-6">
                                    <h6>{{ _("Latest Grade") }}</h6>
                                    ${gradeHtml}
                                </div>
                                <div class="col-6">
                                    <h6>{{ _("Status") }}</h6>
                                    <span class="badge badge-${student.status === 'Active' ? 'success' : 'secondary'}">
                                        ${student.status}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="quick-actions">
                                <a href="#" class="action-btn" onclick="viewStudentAttendance('${student.name}')">
                                    {{ _("Attendance") }}
                                </a>
                                <a href="#" class="action-btn" onclick="viewStudentGrades('${student.name}')">
                                    {{ _("Grades") }}
                                </a>
                                <a href="#" class="action-btn" onclick="viewStudentHomework('${student.name}')">
                                    {{ _("Homework") }}
                                </a>
                                <a href="#" class="action-btn" onclick="requestMeeting('${student.name}')">
                                    {{ _("Request Meeting") }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    $('#children-container').html(`<div class="row">${childrenHtml}</div>`);
    
    // Populate meeting modal student options
    const studentOptions = data.children.map(child => 
        `<option value="${child.student_info.name}">${child.student_info.student_name}</option>`
    ).join('');
    $('#meeting-student').html('<option value="">{{ _("Select student") }}</option>' + studentOptions);
}

function viewStudentAttendance(studentId) {
    frappe.call({
        method: 'easygo_education.api.portal.get_attendance',
        args: {
            student: studentId
        },
        callback: function(r) {
            if (r.message) {
                displayAttendanceModal(r.message, studentId);
            }
        }
    });
}

function displayAttendanceModal(attendance, studentId) {
    const html = attendance.map(record => `
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
                <strong>${frappe.datetime.str_to_user(record.attendance_date)}</strong><br>
                <span class="badge badge-${record.status === 'Present' ? 'success' : 'warning'}">
                    ${record.status}
                </span>
                ${record.is_justified ? '<span class="badge badge-info ml-1">{{ _("Justified") }}</span>' : ''}
            </div>
            <div>
                ${record.time_in ? `<small>{{ _("In") }}: ${record.time_in}</small><br>` : ''}
                ${record.time_out ? `<small>{{ _("Out") }}: ${record.time_out}</small><br>` : ''}
                ${record.status === 'Absent' && !record.is_justified ? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="openJustificationModal('${studentId}', '${record.attendance_date}')">
                        {{ _("Justify") }}
                     </button>` : ''}
            </div>
        </div>
    `).join('');
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="attendanceModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ _("Attendance Records") }}</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${html || '<p class="text-muted">{{ _("No attendance records found") }}</p>'}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal and add new one
    $('#attendanceModal').remove();
    $('body').append(modalHtml);
    $('#attendanceModal').modal('show');
}

function openJustificationModal(studentId, date) {
    $('#justification-student').val(studentId);
    $('#justification-date').val(date);
    $('#justificationModal').modal('show');
}

function submitJustification() {
    const formData = {
        student: $('#justification-student').val(),
        attendance_date: $('#justification-date').val(),
        reason: $('#justification-reason').val() + (
            $('#justification-details').val() ? 
            ': ' + $('#justification-details').val() : ''
        )
    };
    
    frappe.call({
        method: 'easygo_education.api.portal.submit_attendance_justification',
        args: {
            payload: JSON.stringify(formData)
        },
        callback: function(r) {
            if (r.message) {
                frappe.show_alert({
                    message: r.message.message,
                    indicator: 'green'
                });
                $('#justificationModal').modal('hide');
                loadDashboard(); // Refresh dashboard
            }
        }
    });
}

function viewStudentGrades(studentId) {
    window.location.href = `/student-grades?student=${studentId}`;
}

function viewStudentHomework(studentId) {
    window.location.href = `/student-homework?student=${studentId}`;
}

function requestMeeting(studentId) {
    $('#meeting-student').val(studentId);
    
    // Load teachers for the student's class
    const student = dashboardData.children.find(c => c.student_info.name === studentId);
    if (student) {
        loadTeachersForClass(student.student_info.school_class);
    }
    
    $('#meetingModal').modal('show');
}

function loadTeachersForClass(schoolClass) {
    frappe.call({
        method: 'frappe.client.get_list',
        args: {
            doctype: 'Course Schedule',
            filters: {
                school_class: schoolClass,
                is_active: 1
            },
            fields: ['instructor'],
            distinct: true
        },
        callback: function(r) {
            if (r.message) {
                const teacherOptions = r.message.map(item => 
                    `<option value="${item.instructor}">${item.instructor}</option>`
                ).join('');
                $('#meeting-teacher').html('<option value="">{{ _("Select teacher") }}</option>' + teacherOptions);
            }
        }
    });
}

function submitMeetingRequest() {
    const formData = {
        doctype: 'Meeting Request',
        student: $('#meeting-student').val(),
        teacher: $('#meeting-teacher').val(),
        purpose: $('#meeting-purpose').val(),
        preferred_date: $('#meeting-preferred-date').val(),
        preferred_time: $('#meeting-preferred-time').val(),
        notes: $('#meeting-notes').val(),
        requested_by: frappe.session.user,
        status: 'Pending'
    };
    
    frappe.call({
        method: 'frappe.client.insert',
        args: {
            doc: formData
        },
        callback: function(r) {
            if (r.message) {
                frappe.show_alert({
                    message: '{{ _("Meeting request submitted successfully") }}',
                    indicator: 'green'
                });
                $('#meetingModal').modal('hide');
                $('#meeting-form')[0].reset();
            }
        }
    });
}

function viewAllAttendance() {
    window.location.href = '/parent-attendance-summary';
}

function viewAllGrades() {
    window.location.href = '/parent-grades-summary';
}

function viewFees() {
    window.location.href = '/parent-fees';
}

function contactTeacher() {
    window.location.href = '/parent-messages';
}

function toggleLanguage() {
    const currentLang = $('html').attr('lang') || 'en';
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    
    $('html').attr('lang', newLang);
    $('body').toggleClass('rtl', newLang === 'ar');
    $('#lang-text').text(newLang === 'en' ? 'عربي' : 'English');
    
    // Save preference
    frappe.call({
        method: 'frappe.core.doctype.user.user.set_user_preference',
        args: {
            key: 'language',
            value: newLang
        }
    });
}
</script>
{% endblock %}
